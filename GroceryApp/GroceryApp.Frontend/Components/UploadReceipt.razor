@using Microsoft.AspNetCore.Components.Forms
@inject HttpClient Http

<div class="upload-receipt-container">
    <h3>Upload Receipt</h3>
    <InputFile OnChange="HandleSelectedFiles" accept="image/*" />
    @if (selectedFile != null)
    {
        <div class="preview">
            <p>Selected File: @selectedFile.Name</p>
            <img src="@imagePreview" alt="Receipt Preview" />
        </div>
    }
    <button class="upload-button" @onclick="UploadFile" disabled="@(!isFileSelected || isUploading)">Upload</button>
    @if (uploadMessage != null)
    {
        <p class="upload-message">@uploadMessage</p>
    }
</div>

@code {
    private IBrowserFile selectedFile;
    private string imagePreview;
    private bool isFileSelected = false;
    private string uploadMessage;
    private bool isUploading = false;

    private async Task HandleSelectedFiles(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        if (selectedFile != null)
        {
            isFileSelected = true;
            var buffer = new byte[selectedFile.Size];
            await selectedFile.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024).ReadAsync(buffer);
            imagePreview = $"data:image;base64,{Convert.ToBase64String(buffer)}";
            uploadMessage = null;
        }
    }

    private async Task UploadFile()
    {
        if (selectedFile != null)
        {
            try
            {
                isUploading = true;
                uploadMessage = "Uploading...";
                
                using var content = new MultipartFormDataContent();
                var stream = selectedFile.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
                content.Add(new StreamContent(stream), "file", selectedFile.Name);

                var response = await Http.PostAsync("api/upload", content);

                if (response.IsSuccessStatusCode)
                {
                    var result = await response.Content.ReadFromJsonAsync<UploadResponse>();
                    uploadMessage = "Upload successful!";
                    // Optionally display the uploaded image URL
                    // uploadMessage += $" Image URL: {result.Url}";
                }
                else
                {
                    uploadMessage = "Upload failed. Please try again.";
                }
            }
            catch (Exception ex)
            {
                uploadMessage = $"Error: {ex.Message}";
            }
            finally
            {
                isUploading = false;
            }
        }
    }

    public class UploadResponse
    {
        public string Url { get; set; }
    }
}
